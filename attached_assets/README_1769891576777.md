# Crypto Payments - Dokumentacja Projektu

## Przegląd

System płatności kryptowalutowych USDT/USDC dla CFDTrader, umożliwiający:
- Przyjmowanie płatności w USDT i USDC na skonfigurowane adresy
- Obsługę wielu sieci: Arbitrum, Tron, Ethereum
- Automatyczną weryfikację płatności poprzez monitoring blockchain
- Aktywację subskrypcji po potwierdzeniu transakcji

System jest zaprojektowany jako moduł zintegrowany z CFDTrader, wykorzystujący istniejącą architekturę Controller → Service → Repository.

## Dokumenty

| Plik | Opis |
|------|------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | Architektura systemu, komponenty, przepływ danych |
| [API_SPECIFICATION.md](./API_SPECIFICATION.md) | Specyfikacja REST API |
| [BLOCKCHAIN_MONITORING.md](./BLOCKCHAIN_MONITORING.md) | Monitorowanie blockchain, weryfikacja transakcji |
| [TASKS.md](./TASKS.md) | Lista zadań implementacyjnych MVP |

## Kluczowe Założenia

### Model Płatności

1. **Użytkownik podaje swój adres portfela** z którego będzie płacić
2. **Wybiera sieć i token** (Arbitrum/Tron/ETH + USDT/USDC)
3. **Widzi adres odbiorcy i kwotę** do zapłaty
4. **Wysyła przelew** z własnego portfela
5. **Klika "Zapłaciłem"** → status = `awaiting_confirmation`
6. **System monitoruje blockchain** i weryfikuje wpłatę
7. **Po potwierdzeniu** → aktywacja subskrypcji

### Identyfikacja Płatności

System identyfikuje płatności na podstawie **adresu nadawcy** podanego przez użytkownika:
- Użytkownik rejestruje swój adres portfela przed płatnością
- System szuka transferów z tego adresu na nasz adres odbiorcy
- Weryfikuje: token, sieć, kwotę, liczbę potwierdzeń

### Obsługiwane Sieci i Tokeny

| Sieć | Token | Contract Address | Opłaty |
|------|-------|------------------|--------|
| Arbitrum | USDT | 0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9 | ~$0.01 |
| Arbitrum | USDC | 0xaf88d065e77c8cC2239327C5EDb3A432268e5831 | ~$0.01 |
| Tron | USDT | TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t | ~$0.5 |
| Tron | USDC | TEkxiTehnzSmSe2XqrBj4w32RUN966rdz8 | ~$0.5 |
| Ethereum | USDT | 0xdAC17F958D2ee523a2206206994597C13D831ec7 | ~$2-5 |
| Ethereum | USDC | 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 | ~$2-5 |

### Konfiguracja Adresów Odbiorcy

Adresy odbiorcy są przechowywane w zmiennych środowiskowych:
- `PAYMENT_ADDRESS_EVM` - jeden adres dla Arbitrum i Ethereum (ten sam format)
- `PAYMENT_ADDRESS_TRON` - osobny adres dla sieci Tron (format T...)

## Quick Start (dla developera)

```bash
# Wymagane zmienne środowiskowe
PAYMENT_ADDRESS_EVM=0x...        # Adres EVM (Arbitrum + Ethereum)
PAYMENT_ADDRESS_TRON=T...        # Adres Tron

# Opcjonalne RPC (jeśli nie używasz publicznych)
RPC_ARBITRUM=https://arb-mainnet.g.alchemy.com/v2/...
RPC_TRON=https://api.trongrid.io
RPC_ETHEREUM=https://eth-mainnet.g.alchemy.com/v2/...
```

## Wymagane Secrets

```
PAYMENT_ADDRESS_EVM       # Adres EVM do otrzymywania płatności
PAYMENT_ADDRESS_TRON      # Adres Tron do otrzymywania płatności
```

## Plany i Ceny

| Plan | Cena | Okres | Funkcje |
|------|------|-------|---------|
| Standard | 0 USDC | - | Wszystkie funkcje podstawowe |
| Pro (planowany) | TBD | miesięcznie | AI tools, whale tracking |

## Przepływ Użytkownika

```
┌─────────────────────────────────────────────────────────────┐
│  1. Użytkownik wybiera plan                                 │
│     └── GET /api/payments/plans                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. Inicjuje płatność                                       │
│     └── POST /api/payments/initiate                         │
│         - planId, network, token, senderAddress             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. Widzi szczegóły płatności                               │
│     - Adres odbiorcy + QR code                              │
│     - Dokładna kwota do zapłaty                             │
│     - Instrukcje                                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Wysyła przelew z własnego portfela                      │
│     (zewnętrzna aplikacja: MetaMask, TronLink, etc.)        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. Potwierdza płatność                                     │
│     └── POST /api/payments/:id/confirm                      │
│         status: pending → awaiting_confirmation             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. System monitoruje blockchain (co 30s przez 30 min)      │
│     - Szuka transferu z senderAddress na receiverAddress    │
│     - Sprawdza: token, kwota >= wymagana, confirmations     │
└─────────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    ▼               ▼
            ┌───────────┐   ┌───────────┐
            │ Znaleziono│   │ Timeout   │
            │ transakcję│   │ (30 min)  │
            └─────┬─────┘   └─────┬─────┘
                  │               │
                  ▼               ▼
┌─────────────────────────┐ ┌─────────────────────────┐
│  7a. Aktywacja subskr.  │ │  7b. Status = expired   │
│      status = confirmed │ │      Powiadomienie      │
│      Powiadomienie      │ │                         │
└─────────────────────────┘ └─────────────────────────┘
```

## Bezpieczeństwo

- Adresy portfeli są szyfrowane AES-256-GCM
- HMAC-SHA256 dla wyszukiwania adresów
- Weryfikacja na poziomie blockchain (nie ufamy użytkownikowi)
- Minimalna liczba potwierdzeń: 3 (EVM), 19 (Tron)
- Timeout płatności: 30 minut
- Opłaty sieciowe po stronie płatnika

## Integracja z CFDTrader

Moduł płatności jest w pełni zintegrowany z istniejącą architekturą:
- Wykorzystuje istniejący system użytkowników i sesji
- Współdzieli szyfrowanie z walletService
- Używa tego samego design system (shadcn/ui)
- Wykorzystuje istniejące RPC providers dla Ethereum/Arbitrum
