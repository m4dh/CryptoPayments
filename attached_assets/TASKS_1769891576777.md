# Crypto Payments - Lista Zadań MVP

## Przegląd

MVP obejmuje system płatności USDT/USDC na **Arbitrum, Tron i Ethereum** z automatyczną weryfikacją blockchain.

---

## Faza 1: Infrastruktura (Dzień 1)

### 1.1 Konfiguracja

- [ ] Zmienne środowiskowe dla adresów odbiorcy
  - `PAYMENT_ADDRESS_EVM` (Arbitrum + Ethereum)
  - `PAYMENT_ADDRESS_TRON`
- [ ] Konfiguracja sieci i tokenów (`paymentNetworks.ts`)
- [ ] Stałe: tokeny, kontrakty, decimals, min confirmations

### 1.2 Baza Danych

- [ ] Schema: tabela `payments`
- [ ] Schema: tabela `subscriptions`
- [ ] Drizzle schema + typy TypeScript
- [ ] Migracja: `npm run db:push`
- [ ] Indeksy dla wydajności

### 1.3 Repository Layer

- [ ] `paymentRepository.ts` - CRUD dla payments
- [ ] `subscriptionRepository.ts` - CRUD dla subscriptions
- [ ] Metody: findPendingByUser, findByStatus, findExpired, findByTxHash

---

## Faza 2: Backend Services (Dzień 1-2)

### 2.1 PaymentService

- [ ] `getPlans()` - lista planów subskrypcyjnych
- [ ] `initiatePayment()` - tworzenie nowej płatności
  - Walidacja adresu (EVM/Tron)
  - Sprawdzenie istniejących pending
  - Szyfrowanie adresu nadawcy
  - Generowanie QR data
- [ ] `confirmPayment()` - zmiana statusu na awaiting
- [ ] `getPaymentStatus()` - status płatności
- [ ] `cancelPayment()` - anulowanie pending
- [ ] `handleConfirmedTransaction()` - obsługa potwierdzonej tx

### 2.2 SubscriptionService

- [ ] `activate()` - aktywacja subskrypcji po płatności
- [ ] `getCurrentSubscription()` - pobierz aktualną subskrypcję użytkownika
- [ ] `isSubscriptionActive()` - sprawdź czy aktywna
- [ ] `checkExpiration()` - job sprawdzający wygaśnięcie

### 2.3 Address Validation

- [ ] `validateEvmAddress()` - walidacja adresu Ethereum/Arbitrum
- [ ] `validateTronAddress()` - walidacja adresu Tron
- [ ] Checksum validation dla EVM
- [ ] Base58 validation dla Tron

---

## Faza 3: Blockchain Monitoring (Dzień 2-3)

### 3.1 EVM Service (Arbitrum/Ethereum)

- [ ] `EvmBlockchainService` klasa
- [ ] Konfiguracja providerów (ethers.js)
- [ ] `findTransfer()` - szukanie Transfer eventów ERC-20
- [ ] `getTransactionConfirmations()` - liczba potwierdzeń
- [ ] RPC fallback logic
- [ ] Error handling

### 3.2 Tron Service

- [ ] `TronBlockchainService` klasa
- [ ] Konfiguracja TronWeb
- [ ] `findTransfer()` - szukanie transferów TRC-20 via TronGrid API
- [ ] `getTransactionConfirmations()` - liczba potwierdzeń
- [ ] Rate limiting dla TronGrid

### 3.3 Monitor Service

- [ ] `BlockchainMonitorService` klasa
- [ ] Queue management (add, remove, isInQueue)
- [ ] Polling loop (30s interval)
- [ ] Expiration handling (30 min timeout)
- [ ] Retry logic (max 3 retries)
- [ ] Double-spend protection

### 3.4 Scheduler Job

- [ ] `PaymentMonitorJob` klasa
- [ ] Cron: co minutę sprawdź nowe płatności do monitoringu
- [ ] Cron: co 5 minut expire old payments
- [ ] Graceful shutdown

---

## Faza 4: API Controllers (Dzień 3)

### 4.1 Payment Controller

- [ ] `GET /api/payments/plans` - lista planów
- [ ] `GET /api/payments/networks` - obsługiwane sieci
- [ ] `POST /api/payments/initiate` - nowa płatność
- [ ] `POST /api/payments/:id/confirm` - potwierdź wysłanie
- [ ] `GET /api/payments/:id/status` - status płatności
- [ ] `GET /api/payments/history` - historia płatności
- [ ] `DELETE /api/payments/:id` - anuluj płatność
- [ ] `POST /api/payments/validate-address` - walidacja adresu

### 4.2 Subscription Controller

- [ ] `GET /api/subscriptions/current` - aktualna subskrypcja

### 4.3 Routes

- [ ] `routes/payments.ts` - definicje routów
- [ ] Middleware: auth required
- [ ] Validation: Zod schemas
- [ ] Error handling

---

## Faza 5: Frontend (Dzień 3-4)

### 5.1 Hooks

- [ ] `usePaymentPlans` - query dla planów
- [ ] `usePaymentNetworks` - query dla sieci
- [ ] `useInitiatePayment` - mutacja inicjacji
- [ ] `useConfirmPayment` - mutacja potwierdzenia
- [ ] `usePaymentStatus` - query z polling
- [ ] `useSubscription` - aktualna subskrypcja

### 5.2 Components

- [ ] `PaymentPlans.tsx` - lista planów z cenami
- [ ] `NetworkSelector.tsx` - wybór sieci (Arbitrum/Tron/ETH)
- [ ] `TokenSelector.tsx` - wybór tokena (USDT/USDC)
- [ ] `AddressInput.tsx` - input adresu z walidacją
- [ ] `PaymentDetails.tsx` - szczegóły płatności (adres, QR, kwota)
- [ ] `PaymentStatus.tsx` - status z animacją i polling
- [ ] `SubscriptionBadge.tsx` - badge aktywnej subskrypcji

### 5.3 Pages

- [ ] `PaymentPage.tsx` - główna strona płatności
- [ ] `PaymentSuccessPage.tsx` - strona sukcesu
- [ ] Integracja z routingiem (wouter)

### 5.4 UI/UX

- [ ] QR Code generation (qrcode.react)
- [ ] Copy to clipboard dla adresu
- [ ] Countdown timer do wygaśnięcia
- [ ] Loading states i skeleton
- [ ] Toast notifications
- [ ] Responsywność (mobile)

### 5.5 i18n

- [ ] Tłumaczenia PL dla wszystkich tekstów
- [ ] Tłumaczenia EN dla wszystkich tekstów
- [ ] Error messages

---

## Faza 6: Integracja (Dzień 4)

### 6.1 Pricing Page Update

- [ ] Link do strony płatności dla płatnych planów
- [ ] Badge "Coming Soon" dla przyszłych planów
- [ ] CTA button do inicjacji płatności

### 6.2 Profile Integration

- [ ] Wyświetlanie aktualnej subskrypcji
- [ ] Historia płatności w profilu
- [ ] Renewal reminder

### 6.3 Feature Gating

- [ ] Hook `useFeatureAccess` - sprawdzanie dostępu
- [ ] Komponenty wymagające subskrypcji
- [ ] Upgrade prompts

---

## Faza 7: Testing (Dzień 4-5)

### 7.1 Unit Tests

- [ ] `paymentService.test.ts` - logika płatności
- [ ] `addressValidation.test.ts` - walidacja adresów
- [ ] `subscriptionService.test.ts` - logika subskrypcji

### 7.2 Integration Tests

- [ ] `payment.http.test.ts` - API endpoints
- [ ] `subscription.http.test.ts` - API endpoints
- [ ] E2E flow: initiate → confirm → check status

### 7.3 Blockchain Mocks

- [ ] Mock EVM provider dla testów
- [ ] Mock TronGrid API
- [ ] Test scenarios: success, timeout, invalid amount

---

## Faza 8: Security & Polish (Dzień 5)

### 8.1 Security

- [ ] Rate limiting na endpoints
- [ ] Input sanitization
- [ ] Double-spend protection
- [ ] Tx hash uniqueness check
- [ ] Audit logging

### 8.2 Error Handling

- [ ] Graceful RPC failures
- [ ] User-friendly error messages
- [ ] Retry UI dla failed payments

### 8.3 Monitoring

- [ ] Logging dla wszystkich operacji
- [ ] Metrics: pending, confirmed, expired counts
- [ ] Alerts dla błędów monitoringu

### 8.4 Documentation

- [ ] README.md - overview
- [ ] ARCHITECTURE.md - architektura
- [ ] API_SPECIFICATION.md - API docs
- [ ] BLOCKCHAIN_MONITORING.md - monitoring docs
- [ ] Aktualizacja replit.md

---

## Milestones

| Milestone | Target | Deliverable |
|-----------|--------|-------------|
| M1 | Dzień 1 | DB schema + repositories ready |
| M2 | Dzień 2 | Payment + Subscription services working |
| M3 | Dzień 3 | Blockchain monitoring for all networks |
| M4 | Dzień 4 | Full API + Frontend working |
| M5 | Dzień 5 | Tests + Security + Production ready |

---

## Zależności

```
DB Schema → Repositories → Services → Controllers → Frontend
                              │
                              ├─ BlockchainMonitor
                              │     ├─ EvmService
                              │     └─ TronService
                              │
                              └─ SubscriptionService
```

---

## Priorytety

### P0 (Must Have)

- Initiate payment z adresem nadawcy
- Wybór sieci i tokena
- Confirm i monitoring blockchain
- Weryfikacja transakcji
- Aktywacja subskrypcji
- Status polling

### P1 (Should Have)

- QR code dla adresu
- Historia płatności
- Cancel pending payment
- Countdown timer

### P2 (Nice to Have)

- Email notification po potwierdzeniu
- Webhook dla external integrations
- Analytics dashboard
- Auto-renewal

---

## Wymagane Secrets

```bash
# Adresy odbiorcy płatności
PAYMENT_ADDRESS_EVM=0x...        # Arbitrum + Ethereum
PAYMENT_ADDRESS_TRON=T...        # Tron

# Opcjonalne RPC (mamy publiczne fallback)
RPC_ARBITRUM=https://...
RPC_ETHEREUM=https://...
RPC_TRON=https://api.trongrid.io
```

---

## Komendy Dev

```bash
# Database
npm run db:push           # Sync schema

# Development
npm run dev               # Start frontend + backend

# Tests
cd server && npx vitest run tests/payments/

# Logs
# Monitor payment confirmations in console
```

---

## Notatki Implementacyjne

### Bezpieczeństwo adresów

- Adres nadawcy szyfrowany AES-256-GCM
- HMAC-SHA256 dla wyszukiwania
- Adres normalizowany do lowercase przed hashowaniem

### Timeout płatności

- 30 minut od utworzenia
- Po timeout status = 'expired'
- Użytkownik może utworzyć nową płatność

### Minimalne confirmations

- Arbitrum: 3 (~1 minuta)
- Ethereum: 3 (~1 minuta)
- Tron: 19 (~1 minuta)

### Opłaty sieciowe

- Zawsze po stronie płatnika (nadawcy)
- Rekomendacja Arbitrum jako najtańszy
